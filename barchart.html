<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafik Siswa per Tahun - Manajemen Sistem Kesiswaan</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome (untuk ikon) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS (disalin dari halaman lain untuk konsistensi) -->
    <style>
        /* Variabel Warna */
        :root {
            --bg-color: #e0e5ec;
            --primary-blue: #007bff;
            --dark-text: #343a40;
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            --protruding-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            --inset-shadow: inset 6px 6px 12px var(--shadow-dark), inset -6px -6px 12px var(--shadow-light);
            --widget-radius: 18px;
        }

        /* Reset dan Layout Dasar */
        html, body { height: 100%; margin: 0; background-color: var(--bg-color); font-family: 'Poppins', sans-serif; color: var(--dark-text); }
        body { display: flex; flex-direction: column; }
        main { flex: 1 0 auto; padding-top: 80px; padding-bottom: 40px; }

        /* Navbar Styling */
        .navbar { background-color: var(--bg-color) !important; box-shadow: var(--protruding-shadow); color: var(--dark-text); }
        .navbar-brand strong { color: var(--dark-text); }
        .navbar-brand img { width: 40px; height: 40px; padding: 5px; background-color: var(--bg-color); border-radius: 50%; box-shadow: var(--protruding-shadow); object-fit: cover; }
        .navbar-toggler { border: none; background-color: var(--bg-color); box-shadow: var(--protruding-shadow); border-radius: 10px; padding: 0.5rem 0.75rem; transition: box-shadow 0.2s ease; }
        .navbar-toggler:hover, .navbar-toggler:focus { box-shadow: var(--inset-shadow); outline: none; }

        /* Offcanvas Menu Styling */
        .offcanvas.offcanvas-end { background-color: var(--bg-color); color: var(--dark-text); }
        .offcanvas-header { background-color: var(--bg-color); border-bottom: 1px solid var(--shadow-dark); color: var(--dark-text); }
        .user-card { padding: 1.5rem; text-align: center; margin: 1rem; border-radius: var(--widget-radius); box-shadow: var(--inset-shadow); color: var(--dark-text); }
        .user-card img { width: 80px; height: 80px; object-fit: cover; border-radius: 50%; margin-bottom: 1rem; box-shadow: var(--protruding-shadow); padding: 5px; background-color: var(--bg-color); }
        .user-card .user-name { font-weight: 600; font-size: 1.1rem; margin-bottom: 1rem; }
        .user-card .btn, .user-card .btn-login { box-shadow: var(--protruding-shadow); border: none; background-color: var(--bg-color); color: var(--dark-text); border-radius: 10px; padding: 0.5rem 1.2rem; transition: box-shadow 0.2s ease; }
        .user-card .btn:hover, .user-card .btn-login:hover { box-shadow: var(--inset-shadow); }
        .user-card #logout-button { color: #dc3545; }
        .offcanvas-body .nav-link { color: var(--dark-text); margin-bottom: 1rem; border-radius: 12px; box-shadow: var(--protruding-shadow); padding-left: 1.5rem; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .offcanvas-body .nav-link i { margin-right: 0.75rem; width: 20px; text-align: center; }
        .offcanvas-body .nav-link:hover, .offcanvas-body .nav-link:focus { box-shadow: var(--inset-shadow); transform: translateY(2px); }
        .offcanvas-body .nav-link.active { color: var(--primary-blue); box-shadow: var(--inset-shadow); font-weight: 600; }

        /* Footer Styling */
        .footer { padding: 2rem 0; background-color: var(--bg-color); color: var(--dark-text); box-shadow: var(--inset-shadow); }
        .footer-school-name, .footer-school-address { color: var(--dark-text); }
        .footer .social-icons a { display: inline-flex; align-items: center; justify-content: center; width: 50px; height: 50px; border-radius: 50%; margin: 0 10px; font-size: 1.4rem; color: var(--dark-text); background-color: var(--bg-color); box-shadow: var(--protruding-shadow); transition: box-shadow 0.2s ease; }
        .footer .social-icons a:hover { box-shadow: var(--inset-shadow); }

        /* --- Gaya Spesifik untuk Bar Chart --- */
        .page-title { font-size: 2rem; font-weight: 600; text-shadow: 1px 1px 2px var(--shadow-dark), -1px -1px 2px var(--shadow-light); margin-bottom: 2rem !important; text-align: center; }
        .chart-wrap { background-color: var(--bg-color); border: none; border-radius: var(--widget-radius); box-shadow: var(--protruding-shadow); padding: 2rem; }
        .chart-title { text-align: center; margin-bottom: 20px; font-size: 1.5rem; font-weight: 500; }
        
        /* PERUBAHAN: Kontainer utama untuk chart dan sumbu Y */
        .chart-container { display: flex; align-items: flex-end; }

        /* PERUBAHAN: Sumbu Y (label vertikal) */
        .y-axis {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 40px; /* Lebar untuk sumbu Y */
            height: 340px; /* Samakan dengan tinggi .custom-chart */
            padding-bottom: 30px; /* Samakan dengan padding bawah chart */
            text-align: right;
            font-size: 12px;
            color: #6b7280;
            flex-shrink: 0; /* Mencegah sumbu Y menyusut */
        }

        /* PERUBAHAN: Gaya untuk garis grid horizontal */
        .grid-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background-color: #d1d5db; /* Warna garis yang lembut */
            z-index: 1; /* Pastikan garis berada di belakang batang diagram */
        }

        .custom-chart { display: flex; align-items: flex-end; justify-content: space-around; gap: 24px; height: 340px; position: relative; padding-bottom: 30px; overflow-x: auto; padding-left: 10px; padding-right: 10px; flex-grow: 1; /* Biarkan chart mengisi sisa ruang */ }
        .custom-chart::before { content: ""; position: absolute; left: 0; right: 0; bottom: 30px; height: 2px; background: #9ca3af; opacity: 0.3; z-index: 1; }
        .bar-item { display: flex; flex-direction: column; align-items: center; width: 56px; min-width: 40px; position: relative; z-index: 2; }
        .bar-item .value { font-size: 13px; margin-bottom: 8px; color: #1f2937; font-weight: 600; min-height: 18px; }
        .bar-item .bar { width: 100%; border-radius: 6px 6px 3px 3px; background: linear-gradient(145deg, #3b82f6, #1e3a8a); box-shadow: inset 0 2px 5px rgba(255, 255, 255, 0.3), 0 6px 12px rgba(0, 0, 0, 0.2); transition: 0.25s ease; }
        .bar-item .bar:hover { transform: translateY(-5px) scale(1.04); }
        .bar-item .label { margin-top: 10px; font-size: 13px; color: #374151; font-weight: 600; text-align: center; }
    </style>
    <style>
        /* --- PERUBAHAN: Gaya untuk Tooltip Kustom --- */
        .custom-tooltip {
            position: absolute;
            display: none;
            background-color: var(--dark-text);
            color: var(--bg-color);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            z-index: 10;
            box-shadow: var(--protruding-shadow);
            pointer-events: none; /* Penting agar tooltip tidak mengganggu event mouse pada bar */
        }
    </style>
</head>
<body>

    <!-- Header Navbar -->
    <header>
        <nav class="navbar navbar-light bg-light fixed-top">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="index.html">
                    <img src="logo.png" alt="Logo Sekolah" class="me-2">
                    <strong>Manajemen Kesiswaan</strong>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" title="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
        </nav>
    </header>

    <!-- Offcanvas Menu -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Menu Utama</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="user-card p-3 text-center">
                <img id="user-avatar" src="logo.png" alt="Foto User">
                <div id="user-info" class="d-none mt-3">
                    <div class="user-name mb-3">Nama Pengguna</div>
                    <a href="#" id="logout-button" class="btn btn-sm">Logout</a>
                </div>
                <div id="login-prompt" class="mt-3">
                    <button type="button" class="btn btn-sm btn-login" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
                </div>
            </div>
            <ul class="navbar-nav justify-content-end flex-grow-1 p-3">
                <li class="nav-item"><a class="nav-link" href="index.html"><i class="fa-solid fa-home"></i> Beranda</a></li>
                <li id="admin-menu-item" class="nav-item d-none"><a class="nav-link" href="pengaturanadmin.html"><i class="fa-solid fa-user-shield"></i> Pengaturan Administrator</a></li>
                <li id="identitas-sekolah-menu-item" class="nav-item d-none"><a class="nav-link" href="identitas.html"><i class="fa-solid fa-school"></i> Identitas Sekolah</a></li>
                <li id="profil-waka-menu-item" class="nav-item d-none"><a class="nav-link" href="wakasis.html"><i class="fa-solid fa-user-tie"></i> Profil Waka Kesiswaan</a></li>
                <li id="pengaturan-data-menu-item" class="nav-item d-none"><a class="nav-link" href="pengaturandata.html"><i class="fa-solid fa-database"></i> Pengaturan Data</a></li>
                <li class="nav-item"><a class="nav-link" href="datasiswa.html"><i class="fa-solid fa-users"></i> Data Siswa</a></li>
                <li class="nav-item"><a class="nav-link" href="prestasi.html"><i class="fa-solid fa-trophy"></i> Prestasi Siswa</a></li>
                <li class="nav-item"><a class="nav-link" href="bantuan.html"><i class="fa-solid fa-hand-holding-heart"></i> Bantuan Pendidikan</a></li>
                <li class="nav-item"><a class="nav-link" href="putussekolah.html"><i class="fa-solid fa-user-slash"></i> Putus Sekolah</a></li>
                <li class="nav-item"><a class="nav-link" href="mutasi.html"><i class="fa-solid fa-right-left"></i> Mutasi</a></li>
                <li class="nav-item"><a class="nav-link" href="alumni.html"><i class="fa-solid fa-user-graduate"></i> Alumni</a></li>
                <li class="nav-item"><a class="nav-link" href="pembinaan.html"><i class="fa-solid fa-chalkboard-user"></i> Pembinaan Guru/Walas/BK</a></li>
                <li class="nav-item"><a class="nav-link" href="pemanggilan.html"><i class="fa-solid fa-print"></i> Cetak Berkas</a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container">
        <h1 class="page-title">Grafik Siswa Berdasarkan Tahun Masuk</h1>
        <div class="chart-wrap">
            <h2 class="chart-title">Jumlah Siswa per Tahun</h2>
            <!-- PERUBAHAN: Menambahkan kontainer flex untuk sumbu Y dan chart -->
            <div class="chart-container">
                <div class="y-axis" id="y-axis"></div>
                <div class="custom-chart" id="chart"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container text-center">
            <p id="footer-school-name" class="footer-school-name">Nama Sekolah Anda</p>
            <p id="footer-school-address" class="footer-school-address">Alamat Sekolah</p>
            <div class="social-icons mb-2">
                <a href="#" class="facebook" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="twitter" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" class="instagram" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" class="youtube" aria-label="Youtube"><i class="fab fa-youtube"></i></a>
            </div>
            <div class="col-12 text-center mt-3">
                <small>&copy; Kenji Studio Developer 2025.</small>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Skrip Global dan Skrip Halaman -->
    <script src="global.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Panggil fungsi global untuk mengatur UI
            checkLoginStatus();
            loadSchoolIdentity();
            populateLoginUsernames();

            // --- PERUBAHAN: Buat elemen tooltip sekali saja ---
            const tooltip = document.createElement('div');
            tooltip.className = 'custom-tooltip';
            document.body.appendChild(tooltip);

            // Fungsi untuk menghitung frekuensi data
            const countFrequency = (arr, key) => {
                return arr.reduce((acc, item) => {
                    const value = item[key] || 'Tidak Diisi';
                    acc[value] = (acc[value] || 0) + 1;
                    return acc;
                }, {});
            };

            // --- FUNGSI BARU UNTUK MEMBUAT SUMBU Y ---
            function renderYAxis(containerId, maxValue) {
                const axisContainer = document.getElementById('y-axis');
                const chartContainer = document.getElementById('chart'); // Wadah untuk garis grid
                if (!axisContainer) return;
                axisContainer.innerHTML = ''; // Kosongkan sumbu
                chartContainer.querySelectorAll('.grid-line').forEach(line => line.remove()); // Hapus garis grid lama

                const yAxisMax = Math.max(100, Math.ceil(maxValue / 20) * 20); // Pastikan sumbu Y minimal sampai 100
                const increments = 5; // Jumlah interval (100/20 = 5)
                const chartHeight = 280; // Tinggi area chart yang digunakan untuk batang

                for (let i = increments; i >= 0; i--) {
                    const labelValue = (yAxisMax / increments) * i;
                    axisContainer.innerHTML += `<span>${labelValue}</span>`;

                    // --- PERUBAHAN: Tambahkan garis grid horizontal ---
                    const gridLine = document.createElement('div');
                    gridLine.className = 'grid-line';
                    // Hitung posisi 'bottom' berdasarkan persentase tinggi
                    const bottomPosition = (labelValue / yAxisMax) * chartHeight + 30; // +30 untuk padding bawah
                    gridLine.style.bottom = `${bottomPosition}px`;
                    chartContainer.appendChild(gridLine);
                }
            }

            // Fungsi untuk merender diagram batang kustom
            function renderCustomBarChart(containerId, data) {
                const chartContainer = document.getElementById(containerId);
                if (!chartContainer) return;

                chartContainer.innerHTML = ''; // Kosongkan chart sebelum render ulang

                const labels = Object.keys(data).filter(k => k !== 'Tidak Diisi' && k !== 'null').sort((a, b) => a - b);
                if (labels.length === 0) {
                    chartContainer.innerHTML = '<p class="text-center text-muted mt-4">Tidak ada data untuk ditampilkan di grafik.</p>';
                    return;
                }

                const values = labels.map(label => data[label]);
                const maxJumlah = Math.max(...values, 1); // Hindari pembagian dengan nol

                // Render sumbu Y berdasarkan nilai maksimum
                renderYAxis('y-axis', maxJumlah);
                
                const chartHeight = 280; // Tinggi maksimal yang bisa digunakan oleh batang

                labels.forEach(label => {
                    const jumlah = data[label];
                    const itemWrap = document.createElement('div');
                    itemWrap.className = 'bar-item';

                    const valueDiv = document.createElement('div');
                    valueDiv.className = 'value';
                    valueDiv.textContent = jumlah;

                    const barDiv = document.createElement('div');
                    barDiv.className = 'bar';
                    const height = (jumlah / maxJumlah) * chartHeight;
                    barDiv.style.height = height + 'px';

                    // --- PERUBAHAN: Tambahkan event listener untuk tooltip kustom ---
                    barDiv.addEventListener('mouseover', () => {
                        tooltip.textContent = `Tahun ${label}: ${jumlah} siswa`;
                        tooltip.style.display = 'block';
                    });
                    barDiv.addEventListener('mousemove', (e) => {
                        // Posisikan tooltip sedikit di atas dan di kanan kursor
                        tooltip.style.left = (e.pageX + 15) + 'px';
                        tooltip.style.top = (e.pageY + 15) + 'px';
                    });
                    barDiv.addEventListener('mouseout', () => {
                        tooltip.style.display = 'none';
                    });

                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'label';
                    labelDiv.textContent = label;

                    itemWrap.appendChild(valueDiv);
                    itemWrap.appendChild(barDiv);
                    itemWrap.appendChild(labelDiv);
                    chartContainer.appendChild(itemWrap);
                });
            }

            // Ambil data dari sessionStorage
            const siswaDataString = sessionStorage.getItem('siswaData');
            if (siswaDataString) {
                const siswaData = JSON.parse(siswaDataString);
                const tahunMasukData = countFrequency(siswaData, 'tahun_masuk');
                renderCustomBarChart('chart', tahunMasukData);

                // --- PERUBAHAN: Tambahkan listener untuk update real-time ---
                window.addEventListener('storage', (event) => {
                    // Cek apakah item yang berubah adalah 'siswaData'
                    if (event.key === 'siswaData') {
                        console.log('Data siswa di sessionStorage diperbarui. Merender ulang grafik...');
                        const newData = JSON.parse(event.newValue);
                        const newTahunMasukData = countFrequency(newData, 'tahun_masuk');
                        renderCustomBarChart('chart', newTahunMasukData);
                    }
                });
                // --- AKHIR PERUBAHAN ---

            } else {
                // Tampilkan pesan jika tidak ada data
                const chartContainer = document.getElementById('chart');
                chartContainer.innerHTML = '<p class="text-center text-muted mt-4">Data siswa tidak ditemukan. Silakan buka halaman <a href="datasiswa.html">Data Siswa</a> terlebih dahulu.</p>';
            }
        });
    </script>

</body>
</html>
